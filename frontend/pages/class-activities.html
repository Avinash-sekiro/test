<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Class Activities - AI Klassroom</title>
  <link rel="icon" href="/favicon.ico" type="image/x-icon">
  <link rel="stylesheet" href="../css/styles.css">
  <link rel="stylesheet" href="../css/class-activities.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.css" />
  <!-- Auth scripts for authentication functionality -->
  <script src="../js/auth-check.js"></script>
  <script src="../js/session-handler.js"></script>
  <script src="../js/auth.js"></script>
  <!-- Session Manager for tab closing -->
  <script src="../js/session-manager.js"></script>
  <!-- CSS moved to external file: class-activities.css -->
  <style>
    /* New styles for activity subject display */
    body {
      background: linear-gradient(135deg, #f5f7fa 0%, #e4ecfb 100%);
      min-height: 100vh;
    }
    
    .activities-container {
      position: relative;
      padding-bottom: 50px;
    }
    
    /* Activity card grid layout */
    .activities-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(450px, 1fr));
      gap: 30px;
      padding: 20px 0;
    }
    
    /* Modern activity card with glass finish */
    .activity-card {
      background: rgba(255, 255, 255, 0.7);
      border-radius: 16px;
      box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.4);
      border-left: none;
      background-image: 
        linear-gradient(to right, #4B6FE8 0%, #4B6FE8 4px, transparent 4px),
        linear-gradient(135deg, rgba(248, 250, 255, 0.9) 0%, rgba(236, 240, 254, 0.7) 100%);
      overflow: hidden;
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      display: flex;
      flex-direction: column;
      position: relative;
      height: 320px; /* Increased height for more content */
      margin-bottom: 20px;
      padding: 0;
    }
    
    .activity-card:hover {
      box-shadow: 0 10px 50px rgba(75, 111, 232, 0.2);
      transform: translateY(-8px) scale(1.02);
      background-image: 
        linear-gradient(to right, #5E81F4 0%, #5E81F4 5px, transparent 5px),
        linear-gradient(135deg, rgba(252, 253, 255, 0.95) 0%, rgba(229, 237, 255, 0.85) 100%);
    }
    
    .activity-card:hover .card-title {
      color: #4B6FE8;
    }
    
    .activity-card:hover .progress-container {
      transform: scale(1.05);
    }
    
    .card-header {
      padding: 22px 25px 15px;
      position: relative;
      border-bottom: 1px solid rgba(245, 245, 245, 0.6);
      margin-bottom: 5px;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.7) 0%, rgba(255, 255, 255, 0.3) 100%);
    }
    
    .card-title {
      font-size: 1.3rem;
      font-weight: 600;
      color: #333;
      margin: 0;
      margin-bottom: 15px;
      padding-right: 85px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      text-shadow: 0 1px 1px rgba(255, 255, 255, 0.8);
    }
    
    .card-content {
      padding: 0 25px 20px;
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.7) 0%, rgba(255, 255, 255, 0.3) 100%);
    }
    
    .card-subject {
      font-size: 0.95rem;
      color: #3B7DEF;
      font-weight: 600;
      display: inline-block;
      padding: 6px 14px;
      background: rgba(66, 133, 244, 0.12);
      border-radius: 12px;
      margin-bottom: 10px;
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
      box-shadow: 0 2px 6px rgba(66, 133, 244, 0.1);
      border: 1px solid rgba(66, 133, 244, 0.15);
      background-image: linear-gradient(135deg, rgba(66, 133, 244, 0.15) 0%, rgba(66, 133, 244, 0.05) 100%);
      letter-spacing: 0.3px;
    }
    
    .card-description {
      font-size: 0.95rem;
      line-height: 1.6;
      color: #444;
      margin-top: 15px;
      margin-bottom: 20px;
      height: 72px; /* Increased height for description */
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .card-outcome {
      font-size: 0.95rem;
      line-height: 1.6;
      color: #555;
      padding: 14px 18px;
      border-left: 4px solid #4CAF50;
      background: rgba(76, 175, 80, 0.05);
      border-radius: 12px;
      margin-bottom: 25px;
      min-height: 60px;
      max-height: 80px;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
      text-overflow: ellipsis;
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      box-shadow: 0 2px 6px rgba(76, 175, 80, 0.05);
      border-top: 1px solid rgba(255, 255, 255, 0.7);
      border-right: 1px solid rgba(255, 255, 255, 0.7);
      border-bottom: 1px solid rgba(255, 255, 255, 0.7);
    }
    
    .card-meta {
      display: flex;
      align-items: center;
      margin-top: auto;
      margin-bottom: 15px;
      padding-top: 15px;
      border-top: 1px solid rgba(240, 240, 240, 0.5);
      height: 30px;
    }
    
    .card-slides {
      font-size: 0.9rem;
      color: #555;
      margin-left: auto;
      background: rgba(249, 249, 249, 0.7);
      padding: 5px 12px;
      border-radius: 20px;
      font-weight: 500;
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.7);
    }
    
    /* New Progress Bar Styles */
    .progress-container {
      position: absolute;
      top: 18px;
      right: 20px;
      width: 130px;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      z-index: 10;
      transition: all 0.3s ease;
    }
    
    .progress-bar-outer {
      width: 100%;
      height: 18px;
      background: rgba(240, 240, 240, 0.5);
      border-radius: 20px;
      box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.15);
      overflow: hidden;
      padding: 2px;
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      border: 1px solid rgba(255, 255, 255, 0.8);
    }
    
    .progress-bar-inner {
      height: 100%;
      border-radius: 20px;
      background-image: var(--progress-gradient);
      box-shadow: 0 0 8px var(--progress-glow);
      width: 0%;
      transition: width 1s cubic-bezier(0.22, 1, 0.36, 1);
    }
    
    .progress-text {
      font-size: 13px;
      font-weight: 700;
      color: var(--progress-text-color);
      margin-top: 6px;
      letter-spacing: 0.5px;
      text-shadow: 0 1px 1px rgba(255, 255, 255, 0.8);
    }
    
    /* Progress color variations */
    .progress-level-0 {
      --progress-gradient: linear-gradient(90deg, #e0e0e0, #f0f0f0);
      --progress-glow: rgba(0, 0, 0, 0.05);
      --progress-text-color: #999;
    }
    
    .progress-level-low {
      --progress-gradient: linear-gradient(90deg, #FF5722, #FF9800);
      --progress-glow: rgba(255, 87, 34, 0.3);
      --progress-text-color: #FF5722;
    }
    
    .progress-level-medium {
      --progress-gradient: linear-gradient(90deg, #FFC107, #FFEB3B);
      --progress-glow: rgba(255, 193, 7, 0.4);
      --progress-text-color: #FFA000;
    }
    
    .progress-level-high {
      --progress-gradient: linear-gradient(90deg, #4CAF50, #8BC34A);
      --progress-glow: rgba(76, 175, 80, 0.4);
      --progress-text-color: #43A047;
    }
    
    .progress-level-complete {
      --progress-gradient: linear-gradient(90deg, #43A047, #66BB6A);
      --progress-glow: rgba(76, 175, 80, 0.5);
      --progress-text-color: #2E7D32;
    }
    
    /* Animation for new cards */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .fade-in {
      animation: fadeIn 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
      opacity: 0;
    }
    
    /* New styles for detailed activity metadata */
    .activity-detail-metadata {
      font-size: 10px;
      color: #777;
      margin-top: 5px;
      border-top: 1px dashed #eee;
      padding-top: 5px;
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 3px;
    }
    
    .activity-detail-metadata div {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    /* Progress data display */
    .progress-data {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      background: #f9f9f9;
      padding: 2px 6px;
      border-radius: 4px;
      margin-top: 3px;
    }
    
    /* All sections progress bars container */
    .all-sections-progress {
      margin-top: 8px;
      border-top: 1px solid #eee;
      padding-top: 6px;
    }
    
    /* Individual section progress bar */
    .section-progress-bar {
      display: flex;
      align-items: center;
      margin-bottom: 3px;
      font-size: 10px;
    }
    
    .section-label {
      width: 20px;
      font-weight: bold;
      color: #555;
    }
    
    .progress-bar-container {
      flex-grow: 1;
      background: #f3f3f3;
      height: 8px;
      border-radius: 4px;
      margin: 0 4px;
      position: relative;
    }
    
    .progress-bar-fill {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      border-radius: 4px;
    }
    
    .progress-percentage {
      width: 30px;
      text-align: right;
      font-size: 10px;
    }
    
    /* Loader styles */
    .loader {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px 0;
      text-align: center;
    }
    
    .loader-spinner {
      width: 50px;
      height: 50px;
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-radius: 50%;
      border-top: 4px solid #4B6FE8;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>
  <script>
    // This script runs immediately when the page loads
    window.addEventListener('load', function() {
      // Initialize session manager for tab closing only
      if (window.sessionManager) {
        window.sessionManager.init();
        console.log('Session manager initialized');
      }
    });
  </script>
  <header>
    <div class="container">
      <div class="header-content">
        <div class="logo-section" style="display: flex; align-items: center;">
          <button id="logoutBtn" class="btn btn-danger" style="margin-right: 15px;"><i class="fas fa-sign-out-alt"></i> Logout</button>
        <div class="logo" style="position: absolute; left: 0; right: 0; text-align: center;">
          <h1>AI Klassroom</h1>
          </div>
        </div>
        <div style="visibility: hidden;"><!-- Empty space to balance layout --></div>
        <div class="user-info">
          <span id="userEmail"></span>
        </div>
      </div>
    </div>
  </header>

<!-- Toast Notification -->
<div id="toast" style="display:none;">Notification</div>

<!-- TROUBLESHOOTING TOOLS - REMOVE AFTER FIXING -->
<div id="debug-modal" style="display: none; position: fixed; z-index: 2000; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); overflow: auto;">
  <div style="background-color: #fff; margin: 5% auto; padding: 20px; width: 90%; max-width: 800px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); position: relative;">
    <button id="close-debug" style="position: absolute; top: 10px; right: 10px; background: #f44336; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; font-size: 16px; cursor: pointer;">√ó</button>
    <h2 style="margin-top: 0; border-bottom: 1px solid #eee; padding-bottom: 10px;">API Troubleshooting Tool</h2>
    
    <div style="margin-bottom: 20px;">
      <h3>Test API Endpoint</h3>
      <div style="display: flex; gap: 10px; margin-bottom: 15px;">
        <select id="debug-command" style="flex: 1; padding: 8px; border-radius: 4px; border: 1px solid #ddd;">
          <option value="1">Get Activities (cmd=1)</option>
          <option value="2">Get Sections (cmd=2)</option>
          <option value="4">Get Students (cmd=4)</option>
          <option value="5">Update Student Status (cmd=5)</option>
          <option value="6">Reset Students (cmd=6)</option>
        </select>
        <input type="text" id="debug-class" placeholder="Class Number" style="width: 120px; padding: 8px; border-radius: 4px; border: 1px solid #ddd;">
        <input type="text" id="debug-section" placeholder="Section" style="width: 120px; padding: 8px; border-radius: 4px; border: 1px solid #ddd;">
        <button id="send-test-request" style="padding: 8px 15px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;">Send Request</button>
      </div>
    </div>
    
    <div style="display: flex; gap: 20px; margin-bottom: 20px;">
      <div style="flex: 1;">
        <h3>Raw Response</h3>
        <div id="raw-response" style="background: #f5f5f5; padding: 15px; border-radius: 4px; max-height: 400px; overflow: auto; white-space: pre-wrap; font-family: monospace; font-size: 12px; border: 1px solid #ddd;"></div>
      </div>
      <div style="flex: 1;">
        <h3>Parsed Data</h3>
        <div id="parsed-data" style="background: #f5f5f5; padding: 15px; border-radius: 4px; max-height: 400px; overflow: auto; white-space: pre-wrap; font-family: monospace; font-size: 12px; border: 1px solid #ddd;"></div>
      </div>
    </div>
    
    <div>
      <h3>Error Log</h3>
      <div id="error-log" style="background: #fff8f8; color: #d32f2f; padding: 15px; border-radius: 4px; max-height: 150px; overflow: auto; white-space: pre-wrap; font-family: monospace; font-size: 12px; border: 1px solid #ffcdd2;"></div>
    </div>
  </div>
</div>

<!-- Debug button - fixed position -->
<button id="show-debug" style="position: fixed; bottom: 20px; right: 20px; z-index: 1000; background: #ff9800; color: white; border: none; border-radius: 50%; width: 50px; height: 50px; font-size: 24px; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.2);">üõ†Ô∏è</button>
<!-- END TROUBLESHOOTING TOOLS -->

<!-- Logout Confirmation Modal -->
<div id="logout-confirm-modal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
  <div class="modal-content" style="background-color: white; border-radius: 10px; padding: 20px; max-width: 400px; text-align: center; box-shadow: 0 4px 20px rgba(0,0,0,0.2);">
    <h2 style="margin-top: 0; color: #333;">Confirm Logout</h2>
    <p>Are you sure you want to log out?</p>
    <div style="display: flex; justify-content: center; gap: 15px; margin-top: 20px;">
      <button id="confirm-logout-btn" class="btn btn-danger" style="padding: 10px 20px; font-weight: bold;">Yes, Log Out</button>
      <button id="cancel-logout-btn" class="btn" style="background-color: #09ff00; color: white; padding: 10px 20px; font-weight: bold;">Cancel</button>
    </div>
  </div>
</div>

  <main>
    <div class="container">
      <section class="class-selector">
        <div style="display: flex; gap: 20px; justify-content: center; margin-top: 20px;">
          <div class="class-selector-container" style="margin: 0; position: relative; width: 180px;">
            <div id="classDropdownTrigger" class="class-dropdown-trigger" style="padding: 12px 16px; border-radius: 12px; border: none; background: linear-gradient(to right, #4776E6, #8E54E9); color: white; cursor: pointer; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 10px rgba(142, 84, 233, 0.2); transition: all 0.3s ease;">
              <span id="selectedClassText" style="font-weight: 500;">Select Class</span>
              <i class="fas fa-chevron-down dropdown-icon" style="transition: transform 0.3s ease;"></i>
            </div>
            
            <!-- Custom dropdown menu for class selection -->
            <div id="customClassDropdown" class="custom-dropdown" style="display: none; position: absolute; top: 100%; left: 0; width: 100%; background: white; border-radius: 16px; box-shadow: 0 8px 20px rgba(0,0,0,0.15); z-index: 1000; margin-top: 8px; transform-origin: top center; animation: slideDown 0.3s ease-out forwards; overflow: hidden;">
              <div class="dropdown-header" style="background: linear-gradient(to right, #4776E6, #8E54E9); padding: 12px; text-align: center; color: white; font-weight: 500;">Select Class</div>
              <div class="dropdown-item class-item" data-value="1" style="padding: 14px; cursor: pointer; text-align: center; color: #444; transition: all 0.2s ease; border-bottom: 1px solid #f0f0f0;">Class 1</div>
              <div class="dropdown-item class-item" data-value="2" style="padding: 14px; cursor: pointer; text-align: center; color: #444; transition: all 0.2s ease; border-bottom: 1px solid #f0f0f0;">Class 2</div>
              <div class="dropdown-item class-item" data-value="3" style="padding: 14px; cursor: pointer; text-align: center; color: #444; transition: all 0.2s ease; border-bottom: 1px solid #f0f0f0;">Class 3</div>
              <div class="dropdown-item class-item" data-value="4" style="padding: 14px; cursor: pointer; text-align: center; color: #444; transition: all 0.2s ease;">Class 4</div>
            </div>
          </div>
          
          <div id="sectionSelectorContainer" class="class-selector-container" style="margin: 0; display: none; position: relative; width: 180px;">

            <div id="sectionDropdownTrigger" class="class-dropdown-trigger" style="padding: 12px 16px; border-radius: 12px; border: none; background: linear-gradient(to right, #11998e, #38ef7d); color: white; cursor: pointer; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 10px rgba(56, 239, 125, 0.2); transition: all 0.3s ease;">
              <span id="selectedSectionText" style="font-weight: 500;">Select Section</span>
              <i class="fas fa-chevron-down dropdown-icon" style="transition: transform 0.3s ease;"></i>
            </div>
            
            <!-- Custom dropdown menu that appears automatically -->
            <div id="customSectionDropdown" class="custom-dropdown" style="display: none; position: absolute; top: 100%; left: 0; width: 100%; background: white; border-radius: 16px; box-shadow: 0 8px 20px rgba(0,0,0,0.15); z-index: 1000; margin-top: 8px; transform-origin: top center; animation: slideDown 0.3s ease-out forwards; overflow: hidden;">
              <div class="dropdown-header" style="background: linear-gradient(to right, #11998e, #38ef7d); padding: 12px; text-align: center; color: white; font-weight: 500;">Select Section</div>
              <div class="dropdown-item" data-value="A" style="padding: 14px; cursor: pointer; text-align: center; color: #444; transition: all 0.2s ease; border-bottom: 1px solid #f0f0f0;">Section A</div>
              <div class="dropdown-item" data-value="B" style="padding: 14px; cursor: pointer; text-align: center; color: #444; transition: all 0.2s ease; border-bottom: 1px solid #f0f0f0;">Section B</div>
              <div class="dropdown-item" data-value="C" style="padding: 14px; cursor: pointer; text-align: center; color: #444; transition: all 0.2s ease; border-bottom: 1px solid #f0f0f0;">Section C</div>
              <div class="dropdown-item" data-value="D" style="padding: 14px; cursor: pointer; text-align: center; color: #444; transition: all 0.2s ease;">Section D</div>
            </div>
          </div>
        </div>
      </section>

      <section class="activities-container">
        <div id="loader" class="loader hidden">
          <div class="loader-spinner"></div>
          <div style="margin-top: 15px; color: #666; font-weight: 500;">Loading activities...</div>
        </div>
        
        <div id="activitiesGrid" class="activities-grid hidden">
          <!-- Activities will be populated here -->
        </div>
        
        <div id="noActivities" class="no-activities hidden">
          <p>No activities found for the selected class and section.</p>
          <p style="font-size: 0.8rem; color: #666; margin-top: 1rem;">
            If this is unexpected, please ensure the API is configured correctly with the class and section data.
          </p>
        </div>
        
        <div id="activityCount" class="activity-count hidden"></div>
      </section>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="../js/config.js"></script>
  <script src="../js/auth.js"></script>
  
  <!-- Global function to safely navigate to activity page -->
  <script>
    function openActivity(activityId, classNum) {
      console.log('Opening activity:', activityId, 'for class:', classNum);
      
      // Get current section
      const currentSection = localStorage.getItem('selectedSection');
      
      if (!currentSection) {
        console.error('No section selected, cannot open activity');
        showToast('Please select a section first');
        return;
      }
      
      // Store a flag indicating this is an intentional navigation
      sessionStorage.setItem('intentionalNavigation', 'true');
      
      // Store activity ID for later reference
      localStorage.setItem('lastActivityId', activityId);
      
      // Navigate to the activity page with class and section parameters
      window.location.href = `activity_type1.html?id=${activityId}&class=${classNum}&section=${currentSection}`;
    }
  </script>
  
  <script>
    // Use the same Supabase client initialization as activity_type1.html
    const SUPABASE_URL = 'https://zmubswgdqfmleajkccqk.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InptdWJzd2dkcWZtbGVhamtjY3FrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDA2NjUxNjksImV4cCI6MjA1NjI0MTE2OX0.Yh3sHnYDMkeXHoNFg3w-NM-dl9hJFC-omjtIR3KFT2I';
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    // Webhook URL for fetching data
    const WEBHOOK_URL = "https://n8n.srv819941.hstgr.cloud/webhook/5d4dbdb7-c22c-43bd-bda4-5017b5e95264";
    
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize variables
      let allActivities = [];
      let activeSubject = null;
      
      // Logout button event listener
      const logoutBtn = document.getElementById('logoutBtn');
      const logoutConfirmModal = document.getElementById('logout-confirm-modal');
      const confirmLogoutBtn = document.getElementById('confirm-logout-btn');
      const cancelLogoutBtn = document.getElementById('cancel-logout-btn');
      
      if (logoutBtn) {
        logoutBtn.addEventListener('click', function() {
          logoutConfirmModal.style.display = 'flex';
        });
      }
      
      if (confirmLogoutBtn) {
        confirmLogoutBtn.addEventListener('click', async function() {
          try {
            // Clear session storage first
            sessionStorage.clear();
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            showToast('Logging out...');
            
            // Redirect to login page
            setTimeout(() => {
              window.location.href = '../index.html';
            }, 1000);
          } catch (error) {
            console.error('Logout error:', error);
            showToast('Error logging out. Please try again.');
          }
        });
      }
      
      if (cancelLogoutBtn) {
        cancelLogoutBtn.addEventListener('click', function() {
          logoutConfirmModal.style.display = 'none';
        });
      }
      
      // Close modal when clicking outside
      window.addEventListener('click', function(event) {
        if (event.target === logoutConfirmModal) {
          logoutConfirmModal.style.display = 'none';
        }
      });
      
      // Check if user is authenticated using existing stored token
      function isAuthenticated() {
        // Check if there's a stored user in localStorage (same method as in auth.js)
        const storedUser = localStorage.getItem('user');
        return storedUser !== null;
      }
      
      // Check for user role
      function getUserRole() {
        const storedUser = localStorage.getItem('user');
        if (storedUser) {
          try {
            const user = JSON.parse(storedUser);
            return user.role;
          } catch (e) {
            console.error('Error parsing stored user:', e);
            return null;
          }
        }
        return null;
      }
      
      // Check auth and update UI
      function checkAuth() {
        if (!isAuthenticated()) {
          console.log('No authenticated user found. Redirecting to login...');
          // Prevent redirect loop by checking if we're coming from the index page
          if (!document.referrer.includes('index.html')) {
            window.location.href = '../index.html';
          } else {
            // If coming from index, don't redirect again
            console.log('Coming from login page, not redirecting to avoid loop');
            alert('Please log in first before accessing this page');
          }
          return false;
        }

        // User is authenticated, check if role is allowed
        const userRole = getUserRole();
        console.log('User role:', userRole);
        
        // Set user info in the header
        const storedUser = JSON.parse(localStorage.getItem('user'));
        document.getElementById('userEmail').textContent = storedUser.email || '';
        
        // Check if role is allowed
        if (!['schools', 'admin', 'developer'].includes(userRole)) {
          console.log('Unauthorized role:', userRole);
          alert('You do not have permission to access this page');
          window.location.href = '../index.html';
          return false;
        }
        
        return true;
      }
      
      // Check auth on page load - don't redirect if coming from login
      const isUserAuthenticated = checkAuth();
      
      // Handle class and section selection (only if authenticated)
      const classDropdownTrigger = document.getElementById('classDropdownTrigger');
      const sectionDropdownTrigger = document.getElementById('sectionDropdownTrigger');
      const sectionSelectorContainer = document.getElementById('sectionSelectorContainer');
      const selectedClassText = document.getElementById('selectedClassText');
      const selectedSectionText = document.getElementById('selectedSectionText');
      
      // Initialize variables with saved values from localStorage if available
      const savedClass = localStorage.getItem('selectedClass');
      const savedSection = localStorage.getItem('selectedSection');
      let currentClass = savedClass || null;
      let currentSection = savedSection || null;
      
      // Arrays to store available classes and sections
      let availableClasses = [];
      let availableSections = {};
      
      // Function to fetch available classes from webhook
      async function fetchAvailableClasses() {
        try {
          showToast("Fetching available classes...");
          const formData = new FormData();
          formData.append("cmd", "2");  // Use "2" to get all classes and sections at once
          formData.append("user", "auden_cbse");
          formData.append("class", "1"); // Request with class 1 to get all classes and sections
          
          const response = await fetch(WEBHOOK_URL, {
            method: "POST",
            body: formData
          });
          
          if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
          }
          
          const data = await response.text();
          console.log("Classes and sections response:", data);
          
          try {
            const parsedData = JSON.parse(data);
            if (Array.isArray(parsedData)) {
              // Extract classes from the new response format
              availableClasses = parsedData.map(item => {
                // Extract class number from "Class X" format
                const classNum = item.class.replace("Class ", "");
                // Store section count for later use
                availableSections[classNum] = item.no_of_sections;
                return classNum;
              });
              
              console.log("Extracted classes:", availableClasses);
              console.log("Extracted section counts:", availableSections);
              
              populateClassDropdown(availableClasses);
              return availableClasses;
            } else {
              console.error("Invalid data format for classes:", parsedData);
              return [];
            }
          } catch (parseError) {
            console.error("Error parsing classes JSON:", parseError);
            return [];
          }
        } catch (error) {
          console.error("Error fetching classes:", error);
          showToast("Error fetching classes. Using default values.");
          
          // Fallback to default classes
          availableClasses = [1, 2, 3, 4];
          availableSections = {1: 4, 2: 4, 3: 4, 4: 3}; // Default section counts
          populateClassDropdown(availableClasses);
          return availableClasses;
        }
      }
      
      // Function to populate class dropdown
      function populateClassDropdown(classes) {
          const customClassDropdown = document.getElementById('customClassDropdown');
        
        // Clear existing items except the header
        const header = customClassDropdown.querySelector('.dropdown-header');
        customClassDropdown.innerHTML = '';
        customClassDropdown.appendChild(header);
        
        // Add classes to dropdown
        classes.forEach(classNum => {
          const classItem = document.createElement('div');
          classItem.className = 'dropdown-item class-item';
          classItem.setAttribute('data-value', classNum);
          classItem.textContent = `Class ${classNum}`;
          classItem.style.padding = '14px';
          classItem.style.cursor = 'pointer';
          classItem.style.textAlign = 'center';
          classItem.style.color = '#444';
          classItem.style.transition = 'all 0.2s ease';
          classItem.style.borderBottom = '1px solid #f0f0f0';
          
          // Add event listener
          classItem.addEventListener('click', function() {
            const value = this.getAttribute('data-value');
            currentClass = value;
            
            // Update the selected text
            selectedClassText.textContent = `Class ${value}`;
            
            // Save selection to localStorage
            localStorage.setItem('selectedClass', value);
            
            // Clear section selection when class changes
            localStorage.removeItem('selectedSection');
            currentSection = null;
            selectedSectionText.textContent = 'Select Section';
            
            // Hide class dropdown
            document.getElementById('customClassDropdown').style.display = 'none';
            
            // Show section dropdown after class is selected
            sectionSelectorContainer.style.display = 'block';
            
            // Populate sections based on the class's section count (no need to fetch again)
            populateSectionDropdown(value);
            
            // Show custom dropdown menu automatically with a slight delay
            setTimeout(() => {
              // Open the dropdown by simulating a click or focus
              const customDropdown = document.getElementById('customSectionDropdown');
              customDropdown.style.display = 'block';
              
              // Add a highlight effect to draw attention
              sectionSelectorContainer.style.animation = 'pulse 1s';
              setTimeout(() => {
                sectionSelectorContainer.style.animation = '';
              }, 1000);
            }, 50);
            
            // Clear activities until section is selected
            document.getElementById('activitiesGrid').innerHTML = '';
            document.getElementById('noActivities').textContent = 'Please select a section to view activities.';
            document.getElementById('noActivities').classList.remove('hidden');
            document.getElementById('activitiesGrid').classList.add('hidden');
            document.getElementById('activityCount').classList.add('hidden');
          });
          
          customClassDropdown.appendChild(classItem);
        });
        
        // Fix styling for the last item
        const lastItem = customClassDropdown.querySelector('.dropdown-item:last-child');
        if (lastItem) {
          lastItem.style.borderBottom = 'none';
        }
      }
      
      // Function to populate section dropdown based on the class selection
      function populateSectionDropdown(classNum) {
        const customSectionDropdown = document.getElementById('customSectionDropdown');
        
        // Clear existing items except the header
        const header = customSectionDropdown.querySelector('.dropdown-header');
        customSectionDropdown.innerHTML = '';
        customSectionDropdown.appendChild(header);
        
        // Get number of sections for this class from our stored data
        const numSections = availableSections[classNum] || 4; // Default to 4 sections if not specified
        console.log(`Populating ${numSections} sections for Class ${classNum}`);
        
        // Generate section letters (A, B, C, D, etc.) based on the number of sections
        const sections = Array.from({length: numSections}, (_, i) => 
          String.fromCharCode(65 + i) // ASCII 'A' starts at 65, 'B' is 66, etc.
        );
        
        // Add sections to dropdown
        sections.forEach(section => {
          const sectionItem = document.createElement('div');
          sectionItem.className = 'dropdown-item';
          sectionItem.setAttribute('data-value', section);
          sectionItem.textContent = `Section ${section}`;
          sectionItem.style.padding = '14px';
          sectionItem.style.cursor = 'pointer';
          sectionItem.style.textAlign = 'center';
          sectionItem.style.color = '#444';
          sectionItem.style.transition = 'all 0.2s ease';
          sectionItem.style.borderBottom = '1px solid #f0f0f0';
          
          // Add event listener
          sectionItem.addEventListener('click', function() {
            const value = this.getAttribute('data-value');
            currentSection = value;
            
            // Update the selected text
            selectedSectionText.textContent = `Section ${value}`;
            
            // Save selection to localStorage
            localStorage.setItem('selectedSection', value);
            
            // Hide custom dropdown
            document.getElementById('customSectionDropdown').style.display = 'none';
            
            // Load activities
            if (currentClass && currentSection) {
              loadActivities(currentClass, currentSection);
            }
          });
          
          customSectionDropdown.appendChild(sectionItem);
        });
        
        // Fix styling for the last item
        const lastItem = customSectionDropdown.querySelector('.dropdown-item:last-child');
        if (lastItem) {
          lastItem.style.borderBottom = 'none';
        }
      }
      
      // Function to restore saved selections
      function restoreSelections() {
        console.log('Restoring selections:', { currentClass, currentSection });
        
        // Fetch all classes and sections first
        fetchAvailableClasses().then(() => {
          // Set the class selection
          if (currentClass) {
            selectedClassText.textContent = `Class ${currentClass}`;
            // Show section dropdown if class is selected
            sectionSelectorContainer.style.display = 'block';
            
            // Populate sections based on the stored section count
            populateSectionDropdown(currentClass);
            
            // Set section selection if available
            if (currentSection) {
              selectedSectionText.textContent = `Section ${currentSection}`;
              // Load activities for the saved class and section
              if (currentClass && currentSection) {
                console.log('Loading activities from restored selections');
                setTimeout(() => {
                  loadActivities(currentClass, currentSection);
                }, 100);
              }
            }
          }
        });
      }
      
      if (isUserAuthenticated) {
        // Check if we're returning from activity_type1.html page
        const referrer = document.referrer;
        const isReturningFromActivity = referrer.includes('activity_type1.html');
        
        // Restore saved selections when page loads
        if (isReturningFromActivity) {
          // When returning from activity page, ensure we load activities immediately
          console.log('Returning from activity page, loading activities');
          if (currentClass && currentSection) {
            // Use a small delay to ensure DOM is ready
            setTimeout(() => {
              restoreSelections();
            }, 200);
          }
        } else {
          restoreSelections();
        }
        
        // Class dropdown trigger click event
        classDropdownTrigger.addEventListener('click', function() {
          const customClassDropdown = document.getElementById('customClassDropdown');
          customClassDropdown.style.display = customClassDropdown.style.display === 'block' ? 'none' : 'block';
        });
        
        // Section dropdown trigger click event
        sectionDropdownTrigger.addEventListener('click', function() {
          const customSectionDropdown = document.getElementById('customSectionDropdown');
          customSectionDropdown.style.display = customSectionDropdown.style.display === 'block' ? 'none' : 'block';
        });
        
        // Close custom dropdowns when clicking outside
        document.addEventListener('click', function(e) {
          // Handle section dropdown
          const customSectionDropdown = document.getElementById('customSectionDropdown');
          const sectionContainer = document.getElementById('sectionSelectorContainer');
          
          if (customSectionDropdown.style.display === 'block' && 
              !sectionContainer.contains(e.target) && 
              e.target !== sectionDropdownTrigger) {
            customSectionDropdown.style.display = 'none';
          }
          
          // Handle class dropdown
          const customClassDropdown = document.getElementById('customClassDropdown');
          const classContainer = document.querySelector('.class-selector-container');
          
          if (customClassDropdown.style.display === 'block' && 
              !classContainer.contains(e.target) && 
              e.target !== classDropdownTrigger) {
            customClassDropdown.style.display = 'none';
          }
        }, true);
        
        // No default selection - user must select class and section
        document.getElementById('noActivities').textContent = 'Please select a class and section to view activities.';
        document.getElementById('noActivities').classList.remove('hidden');
        document.getElementById('activitiesGrid').classList.add('hidden');
        document.getElementById('activityCount').classList.add('hidden');
        
        // Open class dropdown automatically only during fresh login
        setTimeout(() => {
          // Check if this is a fresh login by looking at session storage
          const isFreshLogin = !sessionStorage.getItem('hasVisitedClassActivities');
          
          // Set flag in session storage to track that user has visited this page
          sessionStorage.setItem('hasVisitedClassActivities', 'true');
          
          // If this is a fresh login or no class is selected, open the dropdown
          if (isFreshLogin || !currentClass) {
            console.log('Fresh login or no class selected, opening class dropdown');
            document.getElementById('customClassDropdown').style.display = 'block';
            // Add a highlight effect to the class dropdown
            document.querySelector('.class-selector-container').style.animation = 'pulse 1s';
            setTimeout(() => {
              document.querySelector('.class-selector-container').style.animation = '';
            }, 1000);
          } else {
            console.log('Not a fresh login and class already selected, keeping selection');
          }
        }, 500);
      }
      
      // Load activities for a specific class and section
      async function loadActivities(classNum, section) {
        console.log(`loadActivities called with class=${classNum}, section=${section}`);
        showLoader();
        
        try {
          console.log(`Loading activities for class ${classNum}, section ${section} from ${WEBHOOK_URL}`);
          
          // Get the logged-in user email and extract user ID (part before @)
          const storedUser = JSON.parse(localStorage.getItem('user')) || {};
          const userEmail = storedUser.email || '';
          
          // Extract the user ID (part before @)
          let userId = 'auden_cbse'; // default fallback
          if (userEmail && userEmail.includes('@')) {
            userId = userEmail.split('@')[0];
            console.log(`Extracted user ID from email: ${userId}`);
          } else {
            console.warn('Could not extract user ID from email, using default:', userId);
          }
          
          // Show toast to indicate data is being loaded
          showToast(`Loading activities for Class ${classNum}, Section ${section}...`);
          
          // Use webhook to get activities data
          const formData = new FormData();
          formData.append("cmd", "1");  // Use "1" for get_activities
          formData.append("user", userId);
          formData.append("class", classNum);
          formData.append("section", section);
          
          console.log("Sending request with parameters:", {
            cmd: "1",
            user: userId,
            class: classNum,
            section: section
          });
          
          const response = await fetch(WEBHOOK_URL, {
            method: "POST",
            body: formData
          });
          
          if (!response.ok) {
            const errorText = await response.text();
            console.error(`HTTP error! Status: ${response.status}, Body: ${errorText}`);
            throw new Error(`HTTP error! Status: ${response.status}`);
          }
          
          // Get response as text first
          const responseText = await response.text();
          console.log("Activities raw response:", responseText);
          
          // Try to parse it as JSON
          let activities = [];
          
          try {
            // First attempt: direct JSON parse
            if (responseText.trim().startsWith('[') || responseText.trim().startsWith('{')) {
              activities = JSON.parse(responseText);
              console.log("Successfully parsed JSON response");
          } else {
              // If not direct JSON, try to extract JSON from the text
              console.warn("Response is not in direct JSON format, trying alternative parsing");
              
              // Look for JSON-like patterns in the response
              const jsonMatch = responseText.match(/\[\s*\{.*\}\s*\]/s);
              if (jsonMatch) {
                try {
                  const extractedJson = jsonMatch[0];
                  console.log("Extracted potential JSON:", extractedJson);
                  activities = JSON.parse(extractedJson);
                  console.log("Successfully parsed extracted JSON");
                } catch (extractError) {
                  console.error("Failed to parse extracted JSON:", extractError);
                  showToast("Error parsing response data");
                }
              } else {
                console.error("No JSON pattern found in response");
                showToast("Unable to parse activities data format");
              }
            }
            
            // Validate that we have an array
            if (!Array.isArray(activities)) {
              console.warn("Activities data is not an array, attempting to convert", typeof activities);
              
              if (typeof activities === 'object') {
                // If it's an object, check if it has a data property
                if (activities.data && Array.isArray(activities.data)) {
                  console.log("Found activities in data property");
                  activities = activities.data;
                } else {
                  // Try to convert object to array
                  console.log("Converting object to array using Object.values()");
                  activities = Object.values(activities);
                }
              } else {
                console.error("Invalid activities data format:", activities);
                throw new Error("Invalid data format: not an array");
              }
            }
            
            // Final validation
            if (!Array.isArray(activities)) {
              console.error("Failed to convert activities to array");
              activities = [];
            }
            
          } catch (parseError) {
            console.error("Error parsing activities JSON:", parseError);
            console.log("Raw response:", responseText);
            showToast("Error parsing response data");
            activities = [];
          }
          
          console.log('Fetched activities:', activities);
          allActivities = activities || [];
          
          // Update UI
          console.log('Rendering activities:', allActivities.length);
          
          if (allActivities.length === 0) {
            showToast("No activities found");
          } else {
            showToast(`Loaded ${allActivities.length} activities`);
          }
          
          renderActivities(allActivities);
          
        } catch (error) {
          console.error('Error loading activities:', error);
          document.getElementById('noActivities').classList.remove('hidden');
          document.getElementById('activitiesGrid').classList.add('hidden');
          document.getElementById('noActivities').textContent = 'Error loading activities. Please try again.';
          showToast("Failed to load activities. Please try again.");
        } finally {
          hideLoader();
        }
      }
      
      // Toast notification function
      function showToast(message) {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.style.display = 'block';
        toast.style.background = '#4B6FE8';
        toast.style.color = 'white';
        toast.style.padding = '12px 20px';
        toast.style.borderRadius = '6px';
        toast.style.position = 'fixed';
        toast.style.bottom = '20px';
        toast.style.left = '50%';
        toast.style.transform = 'translateX(-50%)';
        toast.style.zIndex = '9999';
        toast.style.boxShadow = '0 4px 10px rgba(0,0,0,0.2)';
        toast.style.fontWeight = '500';
        toast.classList.add('show');
        setTimeout(() => {
          toast.classList.remove('show');
          toast.style.display = 'none';
        }, 2500);
      }
      
      // Render activities to the grid
      function renderActivities(activities) {
        console.log('renderActivities called with', activities.length, 'activities');
        const grid = document.getElementById('activitiesGrid');
        const noActivities = document.getElementById('noActivities');
        const activityCount = document.getElementById('activityCount');
        
        if (!grid || !noActivities || !activityCount) {
          console.error('Required DOM elements not found for rendering activities');
          return;
        }
        
        grid.innerHTML = '';
        
        if (!activities || activities.length === 0) {
          grid.classList.add('hidden');
          noActivities.classList.remove('hidden');
          noActivities.textContent = 'No activities found for the selected class and section.';
          activityCount.classList.add('hidden');
          return;
        }
        
        activities.forEach((activity, index) => {
          console.log(`Rendering activity ${index}:`, activity);
          
          // Skip invalid activities
          if (!activity || typeof activity !== 'object') {
            console.warn(`Skipping invalid activity at index ${index}:`, activity);
            return;
          }
          
          const card = document.createElement('div');
          card.className = 'activity-card';
          card.style.animationDelay = `${index * 0.1}s`;
          card.classList.add('fade-in');
          
          // Extract key information with fallbacks to ensure consistent layout
          const activityName = activity.activity_name || 'Untitled Activity';
          const subject = activity.subject || 'General';
          const description = activity.description || 'No description available';
          const outcome = activity.outcome || '';
          
          // Calculate progress for current section - ensure we're working with numbers
          const totalSlides = Number(activity.Total_Slides) || 15;
          
          // Get progress key and value - handle both uppercase and lowercase section names
          const upperSection = currentSection.toUpperCase();
          const lowerSection = currentSection.toLowerCase();
          const possibleProgressKeys = [
            `${upperSection}_Prog`, 
            `${lowerSection}_Prog`,
            `${upperSection}_prog`, 
            `${lowerSection}_prog`,
            `${upperSection}Prog`, 
            `${lowerSection}Prog`,
            `progress_${upperSection}`,
            `progress_${lowerSection}`,
            `progress${upperSection}`,
            `progress${lowerSection}`
          ];
          
          let currentProgress = 0;
          for (const key of possibleProgressKeys) {
            if (key in activity) {
              console.log(`Found progress in field '${key}': ${activity[key]}`);
              // Handle both string and number types
              currentProgress = typeof activity[key] === 'string' 
                ? parseInt(activity[key], 10) || 0 
                : Number(activity[key]) || 0;
              break;
            }
          }
          
          // Calculate percentage
          const progressPercent = Math.min(100, Math.max(0, Math.round((currentProgress / totalSlides) * 100)));
          
          console.log(`Progress calculation: ${currentProgress}/${totalSlides} = ${progressPercent}%`);
          
          // Determine progress class for styling
          let progressClass = '';
          
          if (progressPercent === 0) {
            progressClass = 'progress-level-0';
          } else if (progressPercent === 100) {
            progressClass = 'progress-level-complete';
          } else if (progressPercent < 33) {
            progressClass = 'progress-level-low';
          } else if (progressPercent < 67) {
            progressClass = 'progress-level-medium';
          } else {
            progressClass = 'progress-level-high';
          }
          
          // Create the progress bar HTML
          const progressBarHTML = `
            <div class="progress-container">
              <div class="progress-bar-outer">
                <div class="progress-bar-inner ${progressClass}" style="width: 0%"></div>
              </div>
              <div class="progress-text">${progressPercent}% Complete</div>
            </div>
          `;
          
          // Build card HTML with proper structure - safely escape strings
          const escapeHtml = (text) => {
            if (typeof text !== 'string') return '';
            return text
              .replace(/&/g, '&amp;')
              .replace(/</g, '&lt;')
              .replace(/>/g, '&gt;')
              .replace(/"/g, '&quot;')
              .replace(/'/g, '&#039;');
          };
          
          card.innerHTML = `
            <div class="card-header">
              <h3 class="card-title">${escapeHtml(activityName)}</h3>
              ${progressBarHTML}
            </div>
            <div class="card-content">
              <div class="card-subject">${escapeHtml(subject)}</div>
              <div class="card-description">${escapeHtml(description) || '<span style="color:#aaa;">No description provided</span>'}</div>
              
              ${outcome ? 
                `<div class="card-outcome">${escapeHtml(outcome)}</div>` : 
                `<div class="card-outcome" style="color:#888; font-style:italic;">No specific learning outcome defined</div>`
              }
              
              <div class="card-meta">
                <div class="card-slides">${currentProgress}/${totalSlides} slides</div>
              </div>
            </div>
          `;
          
          // Add to grid first so we can animate the progress bar
          grid.appendChild(card);
          
          // Animate progress bar after a small delay
          setTimeout(() => {
            const progressBar = card.querySelector('.progress-bar-inner');
            if (progressBar) {
              progressBar.style.width = `${progressPercent}%`;
            }
          }, 300 + (index * 100)); // Staggered animation based on card index
          
          // Add click handler to open activity
          const activityId = activity.activity_id || activity.id;
          card.addEventListener('click', function() {
            if (activityId) {
              openActivity(activityId, currentClass);
            } else {
              console.warn("Cannot navigate to activity: missing ID", activity);
              showToast("Cannot open activity: missing ID");
            }
          });
          card.style.cursor = 'pointer';
        });
        
        // Show the grid and hide the "no activities" message
        grid.classList.remove('hidden');
        noActivities.classList.add('hidden');
        activityCount.textContent = `Showing ${activities.length} activities`;
        activityCount.classList.remove('hidden');
      }
      
      // Show/hide loader
      function showLoader() {
        const loader = document.getElementById('loader');
        const activitiesGrid = document.getElementById('activitiesGrid');
        const noActivities = document.getElementById('noActivities');
        const activityCount = document.getElementById('activityCount');
        
        if (loader) loader.classList.remove('hidden');
        if (activitiesGrid) activitiesGrid.classList.add('hidden');
        if (noActivities) noActivities.classList.add('hidden');
        if (activityCount) activityCount.classList.add('hidden');
      }
      
      function hideLoader() {
        const loader = document.getElementById('loader');
        if (loader) loader.classList.add('hidden');
      }
    });
  </script>
  
  <!-- TROUBLESHOOTING TOOLS SCRIPT - REMOVE AFTER FIXING -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Debug modal controls
      const showDebugBtn = document.getElementById('show-debug');
      const closeDebugBtn = document.getElementById('close-debug');
      const debugModal = document.getElementById('debug-modal');
      const sendTestRequestBtn = document.getElementById('send-test-request');
      
      // Debug form elements
      const debugCommand = document.getElementById('debug-command');
      const debugClass = document.getElementById('debug-class');
      const debugSection = document.getElementById('debug-section');
      
      // Debug output areas
      const rawResponseArea = document.getElementById('raw-response');
      const parsedDataArea = document.getElementById('parsed-data');
      const errorLogArea = document.getElementById('error-log');
      
      // Show/hide the debug modal
      showDebugBtn.addEventListener('click', function() {
        debugModal.style.display = 'block';
      });
      
      closeDebugBtn.addEventListener('click', function() {
        debugModal.style.display = 'none';
      });
      
      // Automatically fill fields with current values if available
      if (localStorage.getItem('selectedClass')) {
        debugClass.value = localStorage.getItem('selectedClass');
      }
      
      if (localStorage.getItem('selectedSection')) {
        debugSection.value = localStorage.getItem('selectedSection');
      }
      
      // Send test request
      sendTestRequestBtn.addEventListener('click', async function() {
        const command = debugCommand.value;
        const classValue = debugClass.value;
        const sectionValue = debugSection.value;
        
        // Reset output areas
        rawResponseArea.textContent = 'Sending request...';
        parsedDataArea.textContent = '';
        errorLogArea.textContent = '';
        
        // Check required params
        if (command === '2' && !classValue) {
          errorLogArea.textContent = 'Error: Class number is required for getting sections';
          return;
        }
        
        if ((command === '3' || command === '4') && 
            (!classValue || !sectionValue)) {
          errorLogArea.textContent = 'Error: Both class number and section are required';
          return;
        }
        
        try {
          // Prepare the form data
          const formData = new FormData();
          formData.append("cmd", command);
          formData.append("user", "auden_cbse");
          
          if (classValue) {
            formData.append("class", classValue);
          }
          
          if (sectionValue) {
            formData.append("section", sectionValue);
          }
          
          // Make the request
          const webhookUrl = "https://n8n.srv819941.hstgr.cloud/webhook/5d4dbdb7-c22c-43bd-bda4-5017b5e95264";
          
          // Get command description for display purposes
          const commandDesc = {
            '1': 'Get Activities',
            '2': 'Get Sections',
            '4': 'Get Students',
            '5': 'Update Student Status',
            '6': 'Reset Students'
          }[command] || command;
          
          // Log the request details
          let requestDetails = `REQUEST DETAILS:\n`;
          requestDetails += `URL: ${webhookUrl}\n`;
          requestDetails += `Command: ${commandDesc} (cmd=${command})\n`;
          if (classValue) requestDetails += `Class: ${classValue}\n`;
          if (sectionValue) requestDetails += `Section: ${sectionValue}\n`;
          
          console.log(requestDetails);
          rawResponseArea.textContent = requestDetails + '\nSending request...\n';
          
          // Make the fetch request
          const response = await fetch(webhookUrl, {
            method: "POST",
            body: formData
          });
          
          if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
          }
          
          // Get the raw response text
          const responseText = await response.text();
          console.log('Raw API Response:', responseText);
          
          // Display the raw response
          rawResponseArea.textContent = requestDetails + '\n\nRESPONSE:\n' + responseText;
          
          // Try to parse the response as JSON
          try {
            if (responseText.trim().startsWith('[') || responseText.trim().startsWith('{')) {
              const parsedData = JSON.parse(responseText);
              
              // Format the JSON for better readability
              parsedDataArea.textContent = JSON.stringify(parsedData, null, 2);
              
              // Check if it's an array
              if (Array.isArray(parsedData)) {
                errorLogArea.textContent = `Success: Received an array with ${parsedData.length} items`;
              } else {
                errorLogArea.textContent = 'Warning: Response is a valid JSON object, but not an array';
              }
            } else {
              parsedDataArea.textContent = 'Not valid JSON';
              errorLogArea.textContent = 'Warning: Response is not valid JSON';
            }
          } catch (parseError) {
            console.error('JSON Parse Error:', parseError);
            parsedDataArea.textContent = 'Failed to parse JSON';
            errorLogArea.textContent = `JSON Parse Error: ${parseError.message}`;
          }
        } catch (error) {
          console.error('API Request Error:', error);
          errorLogArea.textContent = `API Request Error: ${error.message}`;
        }
      });
      
      // Enable browser devtools error capturing
      const originalConsoleError = console.error;
      console.error = function() {
        // Call the original console.error
        originalConsoleError.apply(console, arguments);
        
        // Add to our error log
        const errorMessage = Array.from(arguments).join(' ');
        const currentLog = errorLogArea.textContent;
        errorLogArea.textContent = currentLog ? currentLog + '\n' + errorMessage : errorMessage;
      };
    });
  </script>
  <!-- END TROUBLESHOOTING TOOLS SCRIPT -->
</body>
</html>
